<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Hong Kong Bat Acoustic Project</title>
    <!-- Leaflet核心 -->
    <link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- 加入 Lucide 的 CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Responsive Map Size -->
    <link rel="stylesheet" href="./css/global.css" />
  </head>

  <body>
    <div id="map" style="position: relative;">
      <div id="coord-scale-wrapper">
        <div class="crs-selector">
          <select id="crsMode">
            <option value="hk1980"> HK1980 </option>
            <option value="wgs84"> WGS84 </option>
          </select>
          <span id="mouseCoords">X: –, Y: –</span>
        </div>
      </div>
      <a class="leaflet-control leaflet-bar single-btn" href="#" id="fullscreenBtn" style="top: 95px; left: 10px;" title="全螢幕"> <i data-lucide="maximize" style="width: 14px; height: 14px; color: black;"></i> </a>
      <a class="leaflet-control leaflet-bar single-btn" href="#" id="homeBtn" style="top: 130px; left: 10px;" title="Go Home"> <i data-lucide="home" style="width: 14px; height: 14px; color: black;"></i> </a>
      <a class="leaflet-control leaflet-bar single-btn" href="#" id="gotoToggleBtn" style="top: 165px; left: 10px;" title="Go To Point"> <i data-lucide="crosshair" style="width: 14px; height: 14px; color: black;"></i> </a>
      <a class="leaflet-control leaflet-bar single-btn" href="#" id="drawPointBtn" style="top: 200px; left: 10px;" title="Draw Point"> <i data-lucide="map-pin" style="width: 14px; height: 14px; color: black;"></i> </a>
      <a class="leaflet-control leaflet-bar single-btn" href="#" id="locateBtn" style="top: 235px; left: 10px;" title="定位追蹤"> <i data-lucide="navigation" style="width: 14px; height: 14px; color: black;"></i> </a>
      <!-- Go To Point 功能 -->
      <div id="gotoPanel" class="goto-panel">
        <h4 style="margin-top: 0;">Go To Point</h4>
        <div class="goto-row"><input id="modeHK" name="coordMode" type="radio" value="hk1980" /> <label for="modeHK">Easting (X):</label> <input id="inputX" placeholder="828988" type="number" /></div>
        <div class="goto-row"><span></span> <label>Northing (Y):</label> <input id="inputY" placeholder="824199" type="number" /></div>
        <div class="goto-row"><input id="modeWGS" name="coordMode" type="radio" value="wgs84" /> <label for="modeWGS">Latitude:</label> <input id="inputLat" placeholder="22.356" type="number" /></div>
        <div class="goto-row"><span></span> <label>Longitude:</label> <input id="inputLng" placeholder="114.101" type="number" /></div>
        <button id="clearBtn" style="border: none; padding: 6px 12px; border-radius: 6px; margin-right: 8px;">Clear All Point</button>
        <button id="goBtn" style="color: white; border: none; padding: 6px 20px; border-radius: 6px;">Go</button>
      </div>
      <!-- Hover Tooltip -->
      <div id="hoverTooltip" class="hover-tooltip"></div>
    </div>
    <p id="last-modified" style="text-align: center; font-size: 12px; color: gray; margin-top: 30px;"></p>
    <!-- Proj4 轉換工具 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script>
    <script>
      const map = L.map("map");

      const hongKongBounds = [
        [22.15, 113.825],
        [22.55, 114.4],
      ];
      map.fitBounds(hongKongBounds);

      const scaleControl = L.control.scale({ imperial: false });
      scaleControl.addTo(map);

      // 定義正確的 HK1980 與 WGS84 轉換參數
      proj4.defs("EPSG:2326", "+proj=tmerc +lat_0=22.31213333333334 +lon_0=114.1785555555556 +k=1 +x_0=836694.05 +y_0=819069.8 +ellps=intl +towgs84=-162.619,-276.959,-161.764,0.067753,-2.24365,-1.15883,-1.09425 +units=m +no_defs");

      // 等待 Leaflet 載入後將比例尺 DOM 插入 wrapper
      map.whenReady(() => {
        const scaleEl = document.querySelector(".leaflet-control-scale");
        const wrapper = document.getElementById("coord-scale-wrapper");
        if (scaleEl && wrapper) {
          wrapper.appendChild(scaleEl);
        }
        lucide.createIcons(); // 初始化 Lucide Icons
      });

      const streets = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "© OpenStreetMap contributors" }).addTo(map);
      const esriSatellite = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", { attribution: "Tiles © Esri" });
      const cartoLight = L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", { attribution: "CARTO" });
      const googleStreets = L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}", { attribution: "Map data ©2024 Google" });
      const googleSatellite = L.tileLayer("https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}", { attribution: "Imagery ©2024 Google" });
      const googleHybrid = L.tileLayer("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}", { attribution: "Imagery ©2024 Google" });
      const baseMaps = {
        "街道圖 (OSM)": streets,
        "衛星圖 (Esri)": esriSatellite,
        "街道圖 (Carto)": cartoLight,
        "Google 街道圖": googleStreets,
        "Google 衛星圖": googleSatellite,
        "Google 混合圖": googleHybrid,
      };
      const isSmallDevice = window.matchMedia("(max-width: 1023px)").matches;
      const isTouchDevice = "ontouchstart" in window || navigator.maxTouchPoints > 0;
      const layersControl = L.control.layers(baseMaps, {}, { collapsed: true }).addTo(map);
      const gotoMarkers = []; // 儲存 Go To Point 建立的 marker

      // 監聽全屏模式切換，更新按鈕圖示
      document.addEventListener("fullscreenchange", handleFullscreenChange);
      document.addEventListener("webkitfullscreenchange", handleFullscreenChange); // Safari
      document.addEventListener("msfullscreenchange", handleFullscreenChange); // IE11

      function handleFullscreenChange() {
        isFullscreen = !!document.fullscreenElement || !!document.webkitFullscreenElement || !!document.msFullscreenElement || document.getElementById("map").classList.contains("fake-fullscreen");

        fullscreenBtn.innerHTML = isFullscreen ? '<i data-lucide="minimize" style="width: 14px; height: 14px; color: black;"></i>' : '<i data-lucide="maximize" style="width: 14px; height: 14px; color: black;"></i>';

        lucide.createIcons();
      }

      fetch("https://raw.githubusercontent.com/PanTong55/hkgrid/main/OSM_CP.geojson")
        .then((r) => r.json())
        .then((hkcpData) => {
          const hkcpLayer = L.geoJSON(hkcpData, {
            style: {
              color: "#228B22", // 森林綠
              weight: 2,
              fillColor: "#ADFF2F", // 淺綠
              fillOpacity: 0.1,
            },
          });
          layersControl.addOverlay(hkcpLayer, "郊野公圖邊界 (OSM)");
        });

      const crsModeSelect = document.getElementById("crsMode");
      const coordDisplay = document.getElementById("mouseCoords");

      map.on("mousemove", function (e) {
        const mode = crsModeSelect.value;
        if (mode === "wgs84") {
          coordDisplay.textContent = `Lon: ${e.latlng.lng.toFixed(6)}  Lat: ${e.latlng.lat.toFixed(6)}`;
        } else {
          const [x, y] = proj4("EPSG:4326", "EPSG:2326", [e.latlng.lng, e.latlng.lat]);
          coordDisplay.textContent = `X: ${Math.round(x)}  Y: ${Math.round(y)}`;
        }
      });

      // 顯示最後修改時間
      const lastModified = new Date(document.lastModified);
      const formatted = lastModified.toLocaleString("zh-Hant", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
      });
      document.getElementById("last-modified").textContent = "最後修改時間：" + formatted;
    </script>
    <!-- Bat Grid 功能 -->
    <script type="module">
      import { initBatGrid } from "./js/batGrid.js";
      initBatGrid(map, layersControl);
    </script>
    <!-- Full Screen 功能 -->
    <script type="module">
      import { openFullscreen, closeFullscreen, setupFullscreenEvents, handleFullscreenChange, isFullscreen } from "./js/fullscreen.js";

      const fullscreenBtn = document.getElementById("fullscreenBtn");
      const mapContainer = document.getElementById("map");

      fullscreenBtn.addEventListener("click", () => {
        if (!isFullscreen) {
          openFullscreen(mapContainer);
        } else {
          closeFullscreen(mapContainer);
        }
      });

      setupFullscreenEvents(() => {
        fullscreenBtn.innerHTML = isFullscreen ? '<i data-lucide="minimize" style="width: 14px; height: 14px; color: black;"></i>' : '<i data-lucide="maximize" style="width: 14px; height: 14px; color: black;"></i>';
        lucide.createIcons();
      });
    </script>

    <!-- Home Button 功能 -->
    <script type="module">
      import { initHomeButton } from "./js/homeButton.js";

      const hongKongBounds = [
        [22.15, 113.825],
        [22.55, 114.4],
      ];

      initHomeButton(map, "homeBtn", hongKongBounds);
    </script>

    <!-- 實時定位功能 -->
    <script type="module">
      import { initLocateButton, initOrientationListener } from "./js/geolocation.js";

      const mapElement = document.getElementById("map");
      const locateBtnId = "locateBtn";

      initOrientationListener();
      initLocateButton(map, locateBtnId);
    </script>

    <!-- Go to Point 功能 -->
    <script type="module">
      import { initGotoPanel } from "./js/goto.js";
      initGotoPanel(map);
    </script>

    <!-- Draw Point 功能 -->
    <script type="module">
      import { initDrawPoint } from "./js/drawPoints.js";

      const crsModeSelect = document.getElementById("crsMode");
      initDrawPoint(map, crsModeSelect);
    </script>
    <div
      id="alpha-status"
      style="position: absolute; bottom: 10px; right: 10px; background: rgba(255, 255, 255, 0.95); padding: 6px 10px; font-size: 13px; color: #333; border: 1px solid #ccc; border-radius: 6px; font-family: Arial, sans-serif; z-index: 9999;"
    >
      α: --
    </div>
  </body>
</html>
